import { test, expect } from '@playwright/test';
import { FPRTestFramework, TestConfig } from './framework/fpr-test-framework';
import * as XLSX from 'xlsx';
import * as path from 'path';
import * as fs from 'fs';

interface ExpectedRow {
  accountCode: string;
  acal: number;
  anli: number;
  turc: number;
  total: number;
}

function readExpectedResultsFromTmp49D6(filePath: string): ExpectedRow[] {
  if (!fs.existsSync(filePath)) {
    throw new Error(`Excel file not found: ${filePath}`);
  }

  const workbook = XLSX.readFile(filePath);
  console.log(`ðŸ“Š Available sheets: ${workbook.SheetNames.join(', ')}`);
  
  const sheetName = workbook.SheetNames[0];
  console.log(`ðŸ“„ Using sheet: ${sheetName}`);
  
  const worksheet = workbook.Sheets[sheetName];
  const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });

  console.log(`\nðŸ“‹ Excel Structure - First row keys:`);
  if (jsonData.length > 0) {
    console.log(Object.keys(jsonData[0] as any));
    console.log(`\nðŸ“‹ Sample data (first 3 rows):`);
    console.log(JSON.stringify(jsonData.slice(0, 3), null, 2));
  }

  const expectedRows: ExpectedRow[] = jsonData.map((row: any) => {
    // Try different possible column name variations
    const accountCode = String(
      row['Account Code'] || 
      row['AccountCode'] || 
      row['Account'] || 
      row['Code'] || 
      row['ACCOUNT CODE'] ||
      ''
    ).trim();

    const acal = parseFloat(row['ACAL'] || row['acal'] || 0) || 0;
    const anli = parseFloat(row['ANLI'] || row['anli'] || 0) || 0;
    const turc = parseFloat(row['TURC'] || row['turc'] || 0) || 0;
    const total = parseFloat(row['Total'] || row['TOTAL'] || row['total'] || 0) || 0;

    return {
      accountCode,
      acal,
      anli,
      turc,
      total
    };
  }).filter(row => row.accountCode !== ''); // Filter out empty rows

  return expectedRows;
}

function compareWithExpected(actualAccounts: any[], expectedAccounts: ExpectedRow[]) {
  const comparisonResults = [];
  let perfectMatches = 0;
  let mismatches = 0;
  let notFoundInExpected = 0;
  let notFoundInActual = 0;

  console.log('\n================================================================================');
  console.log('ðŸ“Š DETAILED COMPARISON: ACTUAL vs EXPECTED (tmp49D6.xlsx)');
  console.log('================================================================================\n');

  // Create a map of expected accounts for quick lookup
  const expectedMap = new Map<string, ExpectedRow>();
  expectedAccounts.forEach(exp => {
    expectedMap.set(exp.accountCode, exp);
  });

  // Compare actual accounts with expected
  for (const actual of actualAccounts) {
    const actualAccountCode = (actual.account || '').trim();
    
    if (!actualAccountCode) continue;

    const expected = expectedMap.get(actualAccountCode);

    if (!expected) {
      notFoundInExpected++;
      comparisonResults.push({
        accountCode: actualAccountCode,
        status: 'NOT_IN_EXPECTED',
        actual: {
          h1: actual.header1Value,
          h2: actual.header2Value,
          total: actual.totalValue
        },
        expected: null,
        differences: ['Account not found in expected Excel file']
      });
      continue;
    }

    const differences = [];
    const tolerance = 0.01;

    // Compare ACAL (header1)
    if (Math.abs(actual.header1Value - expected.acal) > tolerance) {
      differences.push({
        field: 'ACAL (Header1)',
        expected: expected.acal,
        actual: actual.header1Value,
        diff: actual.header1Value - expected.acal
      });
    }

    // Compare ANLI (header2)
    if (Math.abs(actual.header2Value - expected.anli) > tolerance) {
      differences.push({
        field: 'ANLI (Header2)',
        expected: expected.anli,
        actual: actual.header2Value,
        diff: actual.header2Value - expected.anli
      });
    }

    // Compare TURC - need to check if it's a separate column or calculated
    // For now, let's assume Total = ACAL + ANLI + TURC
    const expectedTotal = expected.acal + expected.anli + expected.turc;
    
    if (Math.abs(actual.totalValue - expected.total) > tolerance) {
      differences.push({
        field: 'Total',
        expected: expected.total,
        actual: actual.totalValue,
        diff: actual.totalValue - expected.total
      });
    }

    // Check if TURC is included (comparing expected total with sum)
    if (Math.abs(expected.total - expectedTotal) > tolerance) {
      differences.push({
        field: 'TURC Calculation',
        expectedSum: expectedTotal,
        expectedTotal: expected.total,
        note: 'TURC value may not be included in sum'
      });
    }

    const status = differences.length === 0 ? 'MATCH' : 'MISMATCH';
    
    if (status === 'MATCH') {
      perfectMatches++;
    } else {
      mismatches++;
    }

    comparisonResults.push({
      accountCode: actualAccountCode,
      status,
      actual: {
        acal: actual.header1Value,
        anli: actual.header2Value,
        turc: expected.turc, // From Excel for reference
        total: actual.totalValue,
        isValid: actual.isValid
      },
      expected: {
        acal: expected.acal,
        anli: expected.anli,
        turc: expected.turc,
        total: expected.total
      },
      differences
    });

    // Mark as found in expected map
    expectedMap.delete(actualAccountCode);
  }

  // Accounts in expected but not in actual
  notFoundInActual = expectedMap.size;
  for (const [accountCode, expected] of expectedMap) {
    comparisonResults.push({
      accountCode,
      status: 'NOT_IN_ACTUAL',
      actual: null,
      expected: {
        acal: expected.acal,
        anli: expected.anli,
        turc: expected.turc,
        total: expected.total
      },
      differences: ['Account not found in actual report']
    });
  }

  return { 
    comparisonResults, 
    perfectMatches, 
    mismatches, 
    notFoundInExpected, 
    notFoundInActual 
  };
}

test('Compare FPR Report with tmp49D6.xlsx for ACAL, ANLI, TURC', async ({ page }) => {
  test.setTimeout(300000);
  
  const config: TestConfig = {
    baseUrl: 'https://sndrydocktest.azurewebsites.net/emarat',
    credentials: {
      username: 'balasubu',
      password: 'SHIPNET88'
    },
    timeout: 300000
  };

  const framework = new FPRTestFramework(page, config);
  const startTime = new Date();
  
  console.log('ðŸŽ¯ TASK: Compare FPR Report with tmp49D6.xlsx');
  console.log('ðŸ“‹ Validation: Account Code + ACAL + ANLI + TURC + Total');
  console.log('ðŸ“ Excel File: tmp49D6.xlsx\n');
  
  // Login and navigate
  console.log('ðŸ“‹ Step 1: Authentication and Navigation');
  await page.setViewportSize({ width: 1920, height: 1080 });
  await framework.login();
  await framework.navigateToFPR();
  
  console.log('ðŸ“‹ Step 2: Template Selection');
  await framework.selectTemplate('Test QA2');
  
  console.log('ðŸ“‹ Step 3: Generate FPR Report');
  await framework.generateReport();
  
  console.log('ðŸ“‹ Step 4: Extract Actual Results from FPR Report');
  const actualResult = await framework.validateReport('FPR Report');
  
  console.log(`\nâœ… Extracted ${actualResult.accounts.length} accounts from FPR Report`);
  console.log(`   Valid account rows: ${actualResult.validAccountRows}`);
  
  // Read expected results from tmp49D6.xlsx
  console.log('\nðŸ“‹ Step 5: Reading Expected Results from tmp49D6.xlsx');
  const excelPath = path.join(process.cwd(), 'data', 'tmp49D6.xlsx');
  
  let expectedAccounts: ExpectedRow[] = [];
  
  try {
    expectedAccounts = readExpectedResultsFromTmp49D6(excelPath);
    console.log(`âœ… Loaded ${expectedAccounts.length} expected accounts from Excel`);
    
    // Show sample of expected data
    if (expectedAccounts.length > 0) {
      console.log(`\nðŸ“‹ Sample Expected Data (first 3 rows):`);
      expectedAccounts.slice(0, 3).forEach((exp, idx) => {
        console.log(`   ${idx + 1}. ${exp.accountCode}`);
        console.log(`      ACAL: ${exp.acal}, ANLI: ${exp.anli}, TURC: ${exp.turc}, Total: ${exp.total}`);
      });
    }
  } catch (error: any) {
    console.error(`âŒ Error reading Excel file: ${error.message}`);
    throw error;
  }
  
  // Compare results
  console.log('\nðŸ“‹ Step 6: Comparing Actual vs Expected Results');
  const { 
    comparisonResults, 
    perfectMatches, 
    mismatches, 
    notFoundInExpected, 
    notFoundInActual 
  } = compareWithExpected(actualResult.accounts, expectedAccounts);
  
  // Display mismatches in detail
  const mismatchedAccounts = comparisonResults.filter(r => r.status === 'MISMATCH');
  if (mismatchedAccounts.length > 0) {
    console.log(`\nâš ï¸  MISMATCHES FOUND (${mismatchedAccounts.length} accounts):`);
    console.log('================================================================================');
    
    mismatchedAccounts.forEach((result, idx) => {
      console.log(`\n${idx + 1}. Account: ${result.accountCode}`);
      if (result.actual) {
        console.log(`   ACTUAL:   ACAL=${result.actual.acal.toFixed(2)}, ANLI=${result.actual.anli.toFixed(2)}, Total=${result.actual.total.toFixed(2)}`);
      }
      console.log(`   EXPECTED: ACAL=${result.expected?.acal.toFixed(2)}, ANLI=${result.expected?.anli.toFixed(2)}, TURC=${result.expected?.turc.toFixed(2)}, Total=${result.expected?.total.toFixed(2)}`);
      console.log(`   Differences:`);
      result.differences.forEach((diff: any) => {
        if (diff.field) {
          console.log(`      ${diff.field}: Expected ${diff.expected}, Got ${diff.actual}, Diff: ${diff.diff}`);
        }
      });
    });
  }
  
  // Display accounts not in expected
  const notFound = comparisonResults.filter(r => r.status === 'NOT_IN_EXPECTED');
  if (notFound.length > 0) {
    console.log(`\nðŸ“‹ ACCOUNTS IN ACTUAL BUT NOT IN EXPECTED (${notFound.length} accounts):`);
    notFound.slice(0, 5).forEach((result, idx) => {
      console.log(`   ${idx + 1}. ${result.accountCode}`);
    });
    if (notFound.length > 5) {
      console.log(`   ... and ${notFound.length - 5} more`);
    }
  }

  // Display accounts not in actual
  const notInActual = comparisonResults.filter(r => r.status === 'NOT_IN_ACTUAL');
  if (notInActual.length > 0) {
    console.log(`\nðŸ“‹ ACCOUNTS IN EXPECTED BUT NOT IN ACTUAL (${notInActual.length} accounts):`);
    notInActual.slice(0, 5).forEach((result, idx) => {
      console.log(`   ${idx + 1}. ${result.accountCode}`);
    });
    if (notInActual.length > 5) {
      console.log(`   ... and ${notInActual.length - 5} more`);
    }
  }
  
  // Summary
  const endTime = new Date();
  const duration = Math.round((endTime.getTime() - startTime.getTime()) / 1000);
  
  console.log('\n================================================================================');
  console.log('ðŸ“Š COMPARISON SUMMARY');
  console.log('================================================================================');
  console.log(`Total Accounts in Actual Report: ${actualResult.accounts.length}`);
  console.log(`Total Accounts in Expected Excel: ${expectedAccounts.length}`);
  console.log(`âœ… Perfect Matches: ${perfectMatches}`);
  console.log(`âš ï¸  Mismatches: ${mismatches}`);
  console.log(`â“ Not Found in Expected: ${notFoundInExpected}`);
  console.log(`â“ Not Found in Actual: ${notFoundInActual}`);
  
  const totalCompared = perfectMatches + mismatches;
  const matchRate = totalCompared > 0 
    ? ((perfectMatches / totalCompared) * 100).toFixed(2) 
    : 0;
  console.log(`ðŸ“Š Match Rate: ${matchRate}%`);
  console.log(`â±ï¸  Total Execution Time: ${duration}s`);
  console.log('================================================================================');
  
  if (perfectMatches === expectedAccounts.length && notFoundInExpected === 0 && notFoundInActual === 0) {
    console.log('ðŸŽ‰ SUCCESS: All accounts match perfectly with expected results!');
  } else if (mismatches === 0) {
    console.log('âœ… All compared accounts match, but some accounts are missing from one source');
  } else {
    console.log('âš ï¸  WARNING: Some accounts do not match the expected results');
  }
  
  // Save detailed comparison to JSON file
  const reportPath = path.join(process.cwd(), 'tmp49D6-comparison-report.json');
  fs.writeFileSync(reportPath, JSON.stringify({
    timestamp: new Date().toISOString(),
    summary: {
      totalActual: actualResult.accounts.length,
      totalExpected: expectedAccounts.length,
      perfectMatches,
      mismatches,
      notFoundInExpected,
      notFoundInActual,
      matchRate: `${matchRate}%`
    },
    details: comparisonResults
  }, null, 2));
  
  console.log(`\nðŸ“„ Detailed comparison report saved to: ${reportPath}`);
  
  // Test assertions
  expect(actualResult.accounts.length).toBeGreaterThan(0);
  expect(expectedAccounts.length).toBeGreaterThan(0);
  
  // Assert that we have a good match rate (at least 80%)
  if (totalCompared > 0) {
    const matchRateNum = (perfectMatches / totalCompared) * 100;
    console.log(`\nðŸ“Š Asserting match rate >= 80%: Current = ${matchRateNum.toFixed(2)}%`);
    expect(matchRateNum).toBeGreaterThanOrEqual(80);
  }
});
